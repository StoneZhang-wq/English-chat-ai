#!/usr/bin/env python3
"""为 dialogues.json 中所有 usage=immersive 的对话添加 user_goal（B方）和 user_goal_a（A方）。
格式：你作为...要完成...。"""
import json
from pathlib import Path

PROJECT_ROOT = Path(__file__).resolve().parent.parent
DIALOGUES_PATH = PROJECT_ROOT / "data" / "dialogues.json"

# 根据 npc 或场景定制的 B 方任务（学习者要完成的）；未命中则用通用句
B_TASK_BY_NPC = {
    "家人": "询问午饭吃什么、帮忙洗菜、找到砧板并道谢。",
    "室友": "询问对方是否在用洗手间或洗衣机、询问物品位置并道谢。",
    "邻居": "询问邻居要干什么并道别。",
    "保安": "询问电梯或方向、是否需要门禁并道谢。",
    "快递员": "找到收件人、请对方签收并道别。",
    "外卖员": "确认房间、报价收款并道别。",
    "路人": "问时间或问路并道谢。",
    "晨练老人": "打招呼、简单寒暄并道别。",
    "医生": "描述症状、配合问诊并道谢。",
    "护士": "配合护士引导或量体温等并道谢。",
    "挂号收费员": "挂号或缴费并道谢。",
    "柜员": "办理业务（存取款等）并道谢。",
    "大堂经理": "咨询业务或求助并道谢。",
    "服务员": "点单或结账并道谢。",
    "咖啡师": "点咖啡并取餐、道谢。",
    "顾客": "作为顾客与店员完成点单或闲聊并道别。",
    "迎宾": "告知人数或预约并随引导入座。",
    "收银员": "结账并道谢。",
    "点餐员": "点餐并取餐、道谢。",
    "配餐员": "取餐并道谢。",
    "店员": "选购或询问商品并结账、道谢。",
    "老板": "点单或询问并道谢。",
    "地勤": "询问登机或行李等并道谢。",
    "安检员": "配合安检并道谢。",
    "空姐/空少": "请求服务（毛毯、饮料等）并道谢。",
    "售票员": "购票或问询并道谢。",
    "检票员": "配合检票并道谢。",
    "司机": "问路或到站并道谢。",
    "前台": "办理入住或咨询并道谢。",
    "客房服务": "请求客房服务并道谢。",
    "保洁": "配合保洁或询问并道谢。",
    "导购员": "询问商品位置或推荐并道谢。",
    "导购": "试穿或选购并道谢。",
    "理发师": "说明需求并配合剪发、道谢。",
    "电影院售票员": "购票并道谢。",
    "电影院检票员": "检票入场并道谢。",
    "领导": "汇报或请示并道谢。",
    "同事": "与同事沟通工作或闲聊并道别。",
    "下属": "接受任务或汇报并道别。",
    "面试官": "作为面试官完成面试并结束。",
    "客户": "与客户沟通需求并道别。",
    "合作伙伴": "与对方沟通合作事宜并道别。",
    "客服": "说明问题并配合解决、道谢。",
    "接线员": "说明来电事由并完成沟通、道谢。",
    "朋友": "与朋友闲聊或约定并道别。",
    "同学": "与同学寒暄或约定并道别。",
    "陌生人": "与陌生人简短打招呼或闲聊并道别。",
    "玩伴": "约玩或商量活动并道别。",
    "同好": "交流爱好并道别。",
    "通用 NPC（朋友/同事/家人）": "赞美、安慰或道歉并得到回应、道别。",
}

# A 方（NPC）在剧本中实际要完成的任务，与 B 方一一对应
A_TASK_BY_NPC = {
    "家人": "告诉午饭吃什么、请对方洗菜、告诉砧板在抽屉、回应道谢。",
    "室友": "告知很快用完、感谢等待、告诉对方物品位置、回应道谢。",
    "邻居": "回答要去做什么、道别。",
    "保安": "指路（电梯或方向）、说明是否需要门禁、回应道谢。",
    "快递员": "确认自己是收件人、签收、道别。",
    "外卖员": "确认房间请进、付款、道别。",
    "路人": "回答时间或指路、回应道谢。",
    "晨练老人": "简单寒暄、道别。",
    "医生": "问诊、给出建议或说明、道别。",
    "护士": "引导或量体温等、回应道谢。",
    "挂号收费员": "办理挂号或收费、回应道谢。",
    "柜员": "办理存取款等业务、回应道谢。",
    "大堂经理": "解答咨询或指引、回应道谢。",
    "服务员": "接待点单或结账、回应道谢。",
    "咖啡师": "接单做咖啡、递餐、回应道谢。",
    "顾客": "点单或与店员闲聊、道别。",
    "迎宾": "询问人数或预约、引导入座。",
    "收银员": "结账收款、回应道谢。",
    "点餐员": "接单、报价、递餐、回应道谢。",
    "配餐员": "递餐、回应道谢。",
    "店员": "介绍商品或结账、回应道谢。",
    "老板": "接单或回答询问、回应道谢。",
    "地勤": "回答登机或行李等问题、回应道谢。",
    "安检员": "引导安检、回应道谢。",
    "空姐/空少": "提供毛毯或饮料等服务、回应道谢。",
    "售票员": "售票或回答问询、回应道谢。",
    "检票员": "检票、回应道谢。",
    "司机": "回答问路或到站、回应道谢。",
    "前台": "办理入住或回答咨询、回应道谢。",
    "客房服务": "提供客房服务、回应道谢。",
    "保洁": "回答或配合、回应道谢。",
    "导购员": "指路或推荐商品、回应道谢。",
    "导购": "协助试穿或选购、回应道谢。",
    "理发师": "确认需求并剪发、道别。",
    "电影院售票员": "售票、回应道谢。",
    "电影院检票员": "检票、回应道谢。",
    "领导": "布置任务或听汇报、回应。",
    "同事": "与对方沟通工作或闲聊、道别。",
    "下属": "接受任务或汇报、道别。",
    "面试官": "提问、倾听回答、结束面试。",
    "客户": "提出需求或反馈、道别。",
    "合作伙伴": "沟通合作内容、道别。",
    "客服": "了解问题并解答或处理、道别。",
    "接线员": "接听并转接或记录、道别。",
    "朋友": "闲聊或约定、道别。",
    "同学": "寒暄或约定、道别。",
    "陌生人": "简短回应或闲聊、道别。",
    "玩伴": "商量活动或约玩、道别。",
    "同好": "交流爱好、道别。",
    "通用 NPC（朋友/同事/家人）": "接受赞美或安慰或道歉、回应、道别。",
}

def get_b_task(npc_name, content):
    """返回学习者（B）要完成的任务描述。"""
    task = B_TASK_BY_NPC.get(npc_name)
    if task:
        return task
    b_lines = [c.get("content", "") for c in content if c.get("role") == "B"]
    if not b_lines:
        return "按剧本完成对话并道别。"
    return "按剧本完成对话并道别。"

def get_a_task(npc_name):
    """返回 NPC（A）在剧本中实际要完成的任务描述。"""
    return A_TASK_BY_NPC.get(npc_name, "按剧本中 A 的台词与学习者完成对话并道别。")

def main():
    with open(DIALOGUES_PATH, "r", encoding="utf-8") as f:
        data = json.load(f)

    if not isinstance(data, list):
        print("dialogues.json 根节点不是数组")
        return

    updated = 0
    for item in data:
        if item.get("usage") != "immersive":
            continue
        content = item.get("content") or []
        npc_name = item.get("npc_name") or "NPC"

        task_b = get_b_task(npc_name, content)
        task_a = get_a_task(npc_name)
        item["user_goal"] = "你作为学习者，要完成" + task_b
        item["user_goal_a"] = "你作为" + npc_name + "，要完成" + task_a
        updated += 1

    with open(DIALOGUES_PATH, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

    print(f"已为 {updated} 条沉浸式对话添加 user_goal 与 user_goal_a。")

if __name__ == "__main__":
    main()
